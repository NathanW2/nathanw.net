---
layout: post
title: Expression based labeling now in QGIS.
tags:
- FOSSGIS
- gis
- Open Source
- osgeo
- qgis
- Quantum GIS
status: publish
type: post
published: true
meta:
  superawesome: 'false'
  _edit_last: '4008903'
  _wpas_mess: ! 'Expression based labeling now in QGIS and the new expression builder.:
    http://wp.me/pjIwZ-e1 #osgeo #qgis #mapping'
  jabber_published: '1319669974'
  _wpas_done_twitter: '1'
  email_notification: '1319669979'
  _wpas_done_linkedin: '1'
  tagazine-media: a:7:{s:7:"primary";s:71:"http://woostuff.files.wordpress.com/2011/10/expression-based-dialog.png";s:6:"images";a:4:{s:65:"http://woostuff.files.wordpress.com/2011/10/expression-labels.png";a:6:{s:8:"file_url";s:65:"http://woostuff.files.wordpress.com/2011/10/expression-labels.png";s:5:"width";s:3:"525";s:6:"height";s:3:"664";s:4:"type";s:5:"image";s:4:"area";s:6:"348600";s:9:"file_path";s:0:"";}s:71:"http://woostuff.files.wordpress.com/2011/10/expression-based-dialog.png";a:6:{s:8:"file_url";s:71:"http://woostuff.files.wordpress.com/2011/10/expression-based-dialog.png";s:5:"width";s:3:"633";s:6:"height";s:3:"588";s:4:"type";s:5:"image";s:4:"area";s:6:"372204";s:9:"file_path";s:0:"";}s:77:"http://woostuff.files.wordpress.com/2011/10/expression-based-dialog-error.png";a:6:{s:8:"file_url";s:77:"http://woostuff.files.wordpress.com/2011/10/expression-based-dialog-error.png";s:5:"width";s:3:"512";s:6:"height";s:3:"149";s:4:"type";s:5:"image";s:4:"area";s:5:"76288";s:9:"file_path";s:0:"";}s:78:"http://woostuff.files.wordpress.com/2011/10/expression-based-dialog-serach.png";a:6:{s:8:"file_url";s:78:"http://woostuff.files.wordpress.com/2011/10/expression-based-dialog-serach.png";s:5:"width";s:3:"321";s:6:"height";s:3:"398";s:4:"type";s:5:"image";s:4:"area";s:6:"127758";s:9:"file_path";s:0:"";}}s:6:"videos";a:0:{}s:11:"image_count";s:1:"4";s:6:"author";s:7:"4008903";s:7:"blog_id";s:7:"4699413";s:9:"mod_stamp";s:19:"2011-10-26
    23:04:29";}
  reddit: a:2:{s:5:"count";s:1:"0";s:4:"time";s:10:"1335526902";}
  image_url: http://woostuff.files.wordpress.com/2011/10/expression-labels.png
  image_md5: d41d8cd98f00b204e9800998ecf8427e
  image_size: a:6:{i:0;s:3:"525";i:1;s:3:"664";i:2;s:1:"3";i:3;s:24:"width="525" height="664"";s:4:"bits";s:1:"8";s:4:"mime";s:9:"image/png";}
  image_tag: <img src="http://woostuff.files.wordpress.com/2011/10/expression-labels.png?w=560"
    class="size-full wp-image-870" title="expression labels"   alt=""    />
  image_colors_bg: a:11:{i:0;s:6:"FFFFFF";s:2:"+1";s:6:"ffffff";s:2:"+2";s:6:"ffffff";s:2:"+3";s:6:"ffffff";s:2:"+4";s:6:"ffffff";s:2:"+5";s:6:"ffffff";i:-1;s:6:"d9d9d9";i:-2;s:6:"bfbfbf";i:-3;s:6:"808080";i:-4;s:6:"404040";i:-5;s:6:"1a1a1a";}
  image_colors_fg: a:11:{i:0;s:6:"404040";s:2:"+1";s:6:"404040";s:2:"+2";s:6:"404040";s:2:"+3";s:6:"404040";s:2:"+4";s:6:"404040";s:2:"+5";s:6:"404040";i:-1;s:6:"404040";i:-2;s:6:"000000";i:-3;s:6:"000000";i:-4;s:6:"ffffff";i:-5;s:6:"ffffff";}
---
QGIS finally has expression based labels! <em>(Although you must be running latest dev build)</em>

What does that mean? Well QGIS used to be only able to label with a field from the layer, very limiting if you need to make a nice looking label string. Now you can use expressions (eg 'Up ' || US_Invert || 'some more text' ) to label the feature, just like this.

[caption id="attachment_870" align="aligncenter" width="525" caption="Example of expression based labels"]<a href="http://woostuff.files.wordpress.com/2011/10/expression-labels.png"><img class="size-full wp-image-870" title="expression labels" src="http://woostuff.files.wordpress.com/2011/10/expression-labels.png" alt="" width="525" height="664" /></a>[/caption]

This is something that I missed a lot when moving from MapInfo to QGIS.  After opening a ticket on the QGIS bug list and nothing happening with it for a couple of months (not that I expected anything to, everyone is busy enough as is.  I don't expect the devs to just jump at all my requests) so I decided I should at least attempt adding it myself.  The joys of open source!

Turns out adding the expression labeling was the easy part, however there was no good generic expression string builder that I could use to build the expression string.  QGIS already had the expression builder for the query window and the field calculator, however the code was very tied down to only work for those implementations, plus they didn't scale with the increasing function list.  I'm not going to go and make yet another dialog just for the labeling.  Uniformity is the key to good user experience.

After searching around to see what other GIS systems did to get some inspiration it seemed that every example that I came across was, in my opinion, poor.    Although there was one ArcGIS idea ticket that gave me a few ideas <a href="http://ideas.arcgis.com/ideaView?id=087300000008IbHAAU">http://ideas.arcgis.com/ideaView?id=087300000008IbHAAU</a>

So with that I started working on a generic expression builder that could be used to build an expression string anywhere, replacing the query window and field calculator in due time. One <span style="text-decoration:line-through;">ring</span> widget to rule them all, one <span style="text-decoration:line-through;">ring</span> widget to bind the, etc.
<h2>The result</h2>
[caption id="attachment_871" align="aligncenter" width="630" caption="Generic expression builder"]<a href="http://woostuff.files.wordpress.com/2011/10/expression-based-dialog.png"><img class="size-full wp-image-871" title="Expression based dialog" src="http://woostuff.files.wordpress.com/2011/10/expression-based-dialog.png" alt="" width="630" height="585" /></a>[/caption]

Key features of the new expression builder:
<ul>
	<li>Live validation of expression</li>
	<li>Real time searching</li>
	<li>Live output preview</li>
	<li>Help on selected item.</li>
	<li>Easier to add new functions without changing the UI.  Function list is read right from the expression parser.  No more hidden functions.</li>
	<li>Reusable widget</li>
</ul>
If the expression hits an error while you type you will be shown an "Expression is invalid" warning <em>(yes I know it's wrong in the screen shot). C</em>licking (more info) or hovering over the expression area will show you the error.

[caption id="attachment_872" align="aligncenter" width="512" caption="Expression has error"]<a href="http://woostuff.files.wordpress.com/2011/10/expression-based-dialog-error.png"><img class="size-full wp-image-872" title="Expression based dialog error" src="http://woostuff.files.wordpress.com/2011/10/expression-based-dialog-error.png" alt="" width="512" height="149" /></a>[/caption]

Searching can done by using the search box at the top. The function list will reduce to show only functions or fields containing that string <em>(Note: it is case sensitive at the current time) .</em>

[caption id="attachment_873" align="aligncenter" width="321" caption="Searching for a function or field name."]<a href="http://woostuff.files.wordpress.com/2011/10/expression-based-dialog-serach.png"><img class="size-full wp-image-873" title="Expression based dialog search" src="http://woostuff.files.wordpress.com/2011/10/expression-based-dialog-serach.png" alt="" width="321" height="398" /></a>[/caption]
<h2>Still to do</h2>
As with all programming it is never bug free so I expect, now that it is open to wider testing, that there might be a few that need to be addressed .   There is also very limited function help written for the functions, although if anyone is willing to have a go at it I'm more than happy.

If you do find any bugs will the widget/dialog you can open a ticket at <a href="http://hub.qgis.org/projects/quantum-gis/issues">http://hub.qgis.org/projects/quantum-gis/issues</a> , assign it to me and I'll see what I can do.
<h2>In the works</h2>
<ul>
	<li>Simple Syntax highlighting</li>
	<li>Recent expression used list</li>
	<li>Saved expressions</li>
	<li>Auto bracketing <em>(maybe)</em></li>
	<li><em></em>UI tweaking</li>
</ul>
I would like to thank Martin from the QGIS team for reviewing my code all though the project and helping me improve the code and idea.  Also thanks to all the other people who gave ideas for the widget/dialog.

<strong>Enjoy!</strong>
