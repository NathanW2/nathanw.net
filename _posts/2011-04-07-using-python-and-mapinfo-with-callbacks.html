---
layout: post
title: Using Python and MapInfo with Callbacks
tags:
- gis
- Mapbasic
- mapinfo
- MapInfo
- mapinfo interop
- mapinfo ole
- MapInfo Professional
- Mapinfo Programming
- mapping
- Open Source
- python
status: publish
type: post
published: true
meta:
  superawesome: 'false'
  _edit_last: '4008903'
  email_notification: '1302181932'
  _wpas_done_twitter: '1'
  reddit: a:2:{s:5:"count";s:1:"0";s:4:"time";s:10:"1335506520";}
  _wpas_mess: ! 'Using Python and MapInfo with Callbacks: http://wp.me/pjIwZ-9o'
  jabber_published: '1302181931'
  tagazine-media: a:7:{s:7:"primary";s:56:"http://woostuff.files.wordpress.com/2011/04/image001.png";s:6:"images";a:1:{s:56:"http://woostuff.files.wordpress.com/2011/04/image001.png";a:6:{s:8:"file_url";s:56:"http://woostuff.files.wordpress.com/2011/04/image001.png";s:5:"width";s:3:"669";s:6:"height";s:3:"388";s:4:"type";s:5:"image";s:4:"area";s:6:"259572";s:9:"file_path";s:0:"";}}s:6:"videos";a:0:{}s:11:"image_count";s:1:"1";s:6:"author";s:7:"4008903";s:7:"blog_id";s:7:"4699413";s:9:"mod_stamp";s:19:"2011-04-07
    13:12:10";}
---
The other day I posted an entry about using MapInfo with Python and Qt (see <a href="http://woostuff.wordpress.com/2011/03/05/mapinfo-map-control-into-qt-python-form/">http://woostuff.wordpress.com/2011/03/05/mapinfo-map-control-into-qt-python-form/</a>), one big thing that I missed was support for callbacks, which if you want to do anything&nbsp;related&nbsp;to&nbsp;integrated mapping is a must for map tool support.

Turns out it is pretty easy, and today I worked out how.

You will need to create a class in python that looks something like this:

[sourcecode language="python"]
class Callback():
    _public_methods_ = ['SetStatusText']
    _reg_progid_ = &quot;MapInfo.PythonCallback&quot;
    _reg_clsid_ = &quot;{14EF8D30-8B00-4B14-8891-36B8EF6D51FD}&quot;
    def SetStatusText(self,status):
        print status
[/sourcecode]

This will be our callback object that we will need to create for MapInfo.

First I will explain what some of the funny stuff is:
<ul>
	<li><strong>_public_methods_</strong> is a Python array of all the methods that you would like to expose to COM eg MapInfo in this case. This attribute is a must for creating a COM object.</li>
	<li><strong>_reg_progid_</strong> is the name of your COM application or object. &nbsp;This can be anything you would like.</li>
	<li><strong>_reg_clsid_</strong> is the GUID, or&nbsp;unique id, for the object or app. &nbsp;Do not use the one I have, call the following in a Python shell to create your own.
[sourcecode language="python"]
         import pythoncom
         pythoncom.CreateGuid()
         [/sourcecode]</li>
	<li><strong>SetStatusText</strong> is the MapInfo callback method that is called when the status bar changes in MapInfo.</li>
</ul>
In order to use the class as a COM object we have two more steps to complete, one is registering the COM object and the other is creating it.

First, in oder to register the object we call the following code from our main Python method:

[sourcecode language="python"]
if __name__ == &quot;__main__&quot;:
    print &quot;Registering COM server...&quot;
    import win32com.server.register
    win32com.server.register.UseCommandLine(Callback)
    main()
[/sourcecode]

This will register the COM object which will mean it can then be creating for use by MapInfo.

In order to create our callback in Python we call:

[sourcecode language="python"]
callback = win32com.client.Dispatch(&quot;MapInfo.PythonCallback&quot;)
[/sourcecode]

and set it as our callback object for MapInfo:

[sourcecode language="python"]
mapinfo.SetCallback(callback)
[/sourcecode]

So after all that the final code looks like this:

[sourcecode language="python"]
def main():
    from PyQt4.QtCore import *
    from PyQt4.QtGui import *
    from win32com.client import Dispatch
    import sys

    app = QApplication(sys.argv)
    app.setAttribute(Qt.AA_NativeWindows,True)
    wnd = QMainWindow()
    wnd.resize(400, 400)
    widget = QWidget()
    wnd.setCentralWidget(widget)
    wnd.show()

    handle = int(widget.winId())
    mapinfo = Dispatch(&quot;MapInfo.Application&quot;)
    callback = win32com.client.Dispatch(&quot;MapInfo.PythonCallback&quot;)
    mapinfo.SetCallback(callback)
    mapinfo.do('Set Next Document Parent %s Style 1' % handle)
    mapinfo.do('Open Table &quot;D:\GIS\MAPS\Property.TAB&quot;')
    mapinfo.do('Map from Property')

    app.exec_()

class Callback():
    &quot;&quot;&quot; Callback class for MapInfo &quot;&quot;&quot;
    _public_methods_ = ['SetStatusText']
    _reg_progid_ = &quot;MapInfo.PythonCallback&quot;
    _reg_clsid_ = &quot;{14EF8D30-8B00-4B14-8891-36B8EF6D51FD}&quot;
    def SetStatusText(self,status):
        print status

if __name__ == &quot;__main__&quot;:
    print &quot;Registering COM server...&quot;
    import win32com.server.register
    win32com.server.register.UseCommandLine(Callback)
    main()
[/sourcecode]

and the result is a map window and information printed to the console.

[caption id="attachment_591" align="aligncenter" width="630" caption="Information from MapInfo callback"]<a href="http://woostuff.files.wordpress.com/2011/04/image001.png"><img class="size-full wp-image-591" title="image001" src="http://woostuff.files.wordpress.com/2011/04/image001.png" alt="" width="630" height="365" /></a>[/caption]

I think Python could be a good language to prototype MapInfo based app, or even build a whole app itself.   If you do end up making something of it let me know I am quite interested with what people could come up with.
