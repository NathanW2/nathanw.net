---
layout: post
title: Opening MS SQL Server 2008 Spatial tables in QGIS - Correctly
tags:
- gis
- map-rendering
- mapping
- MS SQL Server 2008
- MS SQL Spatial
- ogr
- Open Source
- OSS
- qgis
- Quantum GIS
status: publish
type: post
published: true
meta:
  _edit_last: '4008903'
  superawesome: 'false'
  _wpas_mess: ! 'Opening MS SQL Server 2008 Spatial tables in QGIS - Right this time!
    #gis #mapping Please RT to GIS interested people: http://wp.me/pjIwZ-aG'
  jabber_published: '1307425656'
  tagazine-media: a:7:{s:7:"primary";s:0:"";s:6:"images";a:0:{}s:6:"videos";a:0:{}s:11:"image_count";s:1:"0";s:6:"author";s:7:"4008903";s:7:"blog_id";s:7:"4699413";s:9:"mod_stamp";s:19:"2011-06-07
    05:47:36";}
  email_notification: '1307425657'
  _wpas_done_twitter: '1'
  reddit: a:2:{s:5:"count";i:0;s:4:"time";i:1346784928;}
  _wpas_skip_linkedin: '1'
---
<strong>EDIT (22-07-12): QGIS 1.8 and above now ships with a native MS SQL data provider.  Look for Add MSSQL Spatial Layer in the Layer menu.</strong>

Turns out the <a title="Opening MS SQL Server 2008 Spatial tables in QGIS" href="http://woostuff.wordpress.com/2011/03/13/opening-ms-sql-spatial-in-qgis/">last blog post</a> I did on this subject contained a few errors, mainly that QGIS wouldn't render the layer when you opened it.

The answer is so obvious it's almost embarrassing :)

In order to open and display a SQL Server 2008 layer in QGIS correctly, via OGR, you must have a geometry_columns table in your database with the name, geometry type and srid of the layer. That's it! Oh look, it was even right in front of me in the OGR code for the mssqlspatial driver.

[sourcecode language="cpp"]
int OGRMSSQLSpatialTableLayer::FetchSRSId()
{
    CPLODBCStatement oStatement = CPLODBCStatement( poDS-&gt;GetSession() );
    oStatement.Appendf( &quot;select srid from geometry_columns &quot;
                    &quot;where f_table_schema = '%s' and f_table_name = '%s'&quot;,
                    pszSchemaName, pszTableName );

    if( oStatement.ExecuteSQL() &amp;&amp; oStatement.Fetch() )
    {
        if ( oStatement.GetColData( 0 ) )
            nSRSId = atoi( oStatement.GetColData( 0 ) );
    }

    return nSRSId;
}
[/sourcecode]

<strong>So the process to open a MS SQL 2008 spatial layer in OGR is as follows.</strong>

There are two main tables which tell OGR how to read a layers projection:
<ul>
	<li>geometry_columns</li>
	<li>spatial_ref_sys</li>
</ul>
<em><strong>geometry_columns</strong></em> contains the table name and the key for the table <em><strong>spatial_ref_sys</strong></em> which contains the projection string. The projection string is the info that QGIS needs in order to correctly render a layer.

The easiest way to get the correct tables is to let OGR handle it for you via ogr2ogr, then just adding any other tables you may have already in your database to the geometry_columns table.

So to get ogr2ogr to create the right tables for you it's as simple as running the following command from inside the OSGeo4W shell, changing the connection string part of course:

[sourcecode language="bash"]
ogr2ogr -overwrite -f MSSQLSpatial &quot;MSSQL:server=.\MSSQLSERVER2008;database=geodb;trusted_connection=yes&quot; &quot;rivers.tab&quot;
[/sourcecode]

<em>(sample taken from <a href="http://www.gdal.org/ogr/drv_mssqlspatial.html">http://www.gdal.org/ogr/drv_mssqlspatial.html</a>)</em>

Uploading even just one table this way will create both tables and fill in the needed info.
The <strong>geometry_columns </strong>table:

f_table_catalogf_table_schemaf_table_namef_geometry_column
<table>
<tbody>
<tr>
<td>geodb</td>
<td>dbo</td>
<td>rivers</td>
<td>ogr_geometry</td>
</tr>
</tbody>
</table>
coord_dimensionsridgeometry_type
<table>
<tbody>
<tr>
<td>2</td>
<td>32768</td>
<td>POLYGON</td>
</tr>
</tbody>
</table>
The <strong>spatial_ref_sys </strong>table:

sridauth_nameauth_sridsrtextproj4text
<table>
<tbody>
<tr>
<td>32768</td>
<td>NULL</td>
<td>NULL</td>
<td>PROJCS["UTM_Zone_56_Southern_Hemisph....</td>
<td>+proj=utm +zone=56 +south +ellps=GRS80 +units=m +no_defs</td>
</tr>
</tbody>
</table>
So if you have already existing tables in your MS SQL 2008 database that were loaded, via say MapInfo's EasyLoader, you would just upload one table via ogr2ogr to create the two tables needed by QGIS(using OGR) and then add the other tables to the geometry_columns table. If they are all in the same projection than you are in luck as you will only need to upload one in order to get the right strings in the spatial_ref_sys table, if not just upload a small sample for each projection.

Then you can open the table in QGIS using:

[sourcecode language="python"]
uri = &quot;MSSQL:server={serverName};database={databaseName};tables={tableName};trusted_connection=yes&quot;
qgis.utils.iface.addVectorLayer(uri,'{yourLayerNameHere}','ogr')
[/sourcecode]

<strong>Tip:</strong> In order to test you have correctly set the table in geometry_columns you can run another ogr tool ogrinfo:

[sourcecode language="bash"]
ogrinfo -al &quot;MSSQL:server=localhost;database={your database};tables={your table}&quot; -fid 1
[/sourcecode]

If you see a value in Layer SRS WKT: then chances are it's set right and QGIS should be able to render it, however if you see: Layer SRS WKT:(unknown) Than chances are QGIS will not render it correctly.

Hopefully this help people use MS SQL 2008 Spatial with QGIS, a important step I think in the world of using QGIS on Windows (especially when you don't have the freedom to run PostGIS:) ).

I might even do a video tutorial when I get some free time after my exams and my wedding.
