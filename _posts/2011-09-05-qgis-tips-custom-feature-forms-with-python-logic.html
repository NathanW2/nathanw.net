---
layout: post
title: QGIS Tips - Custom feature forms with Python logic
tags:
- FOSSGIS
- gis
- Open Source
- qgis
- qgis-editing
- Quantum GIS
status: publish
type: post
published: true
meta:
  superawesome: 'false'
  _edit_last: '4008903'
  jabber_published: '1315181327'
  email_notification: '1315181328'
  reddit: a:2:{s:5:"count";i:0;s:4:"time";i:1346470516;}
  _wpas_mess: ! 'QGIS Tips- Custom feature forms with Python logic #gis #mapping #qgis
    #FOSSGIS :'
  _wpas_done_twitter: '1'
  tagazine-media: a:7:{s:7:"primary";s:56:"http://woostuff.files.wordpress.com/2011/09/designer.png";s:6:"images";a:7:{s:56:"http://woostuff.files.wordpress.com/2011/09/designer.png";a:6:{s:8:"file_url";s:56:"http://woostuff.files.wordpress.com/2011/09/designer.png";s:5:"width";s:3:"990";s:6:"height";s:3:"693";s:4:"type";s:5:"image";s:4:"area";s:6:"686070";s:9:"file_path";s:0:"";}s:60:"http://woostuff.files.wordpress.com/2011/09/objectnaming.png";a:6:{s:8:"file_url";s:60:"http://woostuff.files.wordpress.com/2011/09/objectnaming.png";s:5:"width";s:3:"311";s:6:"height";s:3:"199";s:4:"type";s:5:"image";s:4:"area";s:5:"61889";s:9:"file_path";s:0:"";}s:58:"http://woostuff.files.wordpress.com/2011/09/properties.png";a:6:{s:8:"file_url";s:58:"http://woostuff.files.wordpress.com/2011/09/properties.png";s:5:"width";s:3:"649";s:6:"height";s:3:"625";s:4:"type";s:5:"image";s:4:"area";s:6:"405625";s:9:"file_path";s:0:"";}s:59:"http://woostuff.files.wordpress.com/2011/09/mapwithform.png";a:6:{s:8:"file_url";s:59:"http://woostuff.files.wordpress.com/2011/09/mapwithform.png";s:5:"width";s:3:"923";s:6:"height";s:3:"629";s:4:"type";s:5:"image";s:4:"area";s:6:"580567";s:9:"file_path";s:0:"";}s:65:"http://woostuff.files.wordpress.com/2011/09/propertiesupdated.png";a:6:{s:8:"file_url";s:65:"http://woostuff.files.wordpress.com/2011/09/propertiesupdated.png";s:5:"width";s:3:"649";s:6:"height";s:3:"625";s:4:"type";s:5:"image";s:4:"area";s:6:"405625";s:9:"file_path";s:0:"";}s:56:"http://woostuff.files.wordpress.com/2011/09/validate.png";a:6:{s:8:"file_url";s:56:"http://woostuff.files.wordpress.com/2011/09/validate.png";s:5:"width";s:3:"929";s:6:"height";s:3:"627";s:4:"type";s:5:"image";s:4:"area";s:6:"582483";s:9:"file_path";s:0:"";}s:52:"http://woostuff.files.wordpress.com/2011/09/form.png";a:6:{s:8:"file_url";s:52:"http://woostuff.files.wordpress.com/2011/09/form.png";s:5:"width";s:3:"314";s:6:"height";s:3:"179";s:4:"type";s:5:"image";s:4:"area";s:5:"56206";s:9:"file_path";s:0:"";}}s:6:"videos";a:0:{}s:11:"image_count";s:1:"7";s:6:"author";s:7:"4008903";s:7:"blog_id";s:7:"4699413";s:9:"mod_stamp";s:19:"2011-09-05
    23:46:25";}
  _wpas_skip_linkedin: '1'
---
Last week I found a nice little undocumented feature of QGIS. I plan on writing documentation, so it won't stay that way for long but I thought I would post about it first and run though it step by step.

<em>This post is going to be a follow up post based on what Tim Sutton did for the same subject back in 2009 at <a href="http://linfiniti.com/2009/11/creating-dynamic-forms-a-new-feature-headed-for-qgis-1-4/">http://linfiniti.com/2009/11/creating-dynamic-forms-a-new-feature-headed-for-qgis-1-4/ </a></em>

For data entry one feature I really like in QGIS is the automatic feature edit forms with support for textboxs, dropdowns and all sorts of other cool Qt controls to make data entry a breeze.

However one thing that people might not be aware of is that you can have a custom forms for data entry. QGIS will take care of setting all the fields and then saving the values back to your layer.

This could be handy if you want to have say a logo, some validation and maybe some text to help the user fill in the form correctly. Or just a custom form layout because you can.

One thing Tim didn't follow up on was a post about how to add custom Python logic to the form, which I think is the coolest feature of having these custom forms.

So lets get started.
<h2>Creating the custom form</h2>
This process is pretty much the same as what Tim outlined in his <a href="http://linfiniti.com/2009/11/creating-dynamic-forms-a-new-feature-headed-for-qgis-1-4/">blog post</a> however I'm going to go over it again for completeness.

In order to create the custom form you will need to install Qt Desinger. For windows I haven't found a way to just install the desinger although if you have QGIS installed it is normally installed with the Qt framework and can be found at C:\OSGeo4w\bin\designer.exe. If you're on Linux you can run something like

[sourcecode language="bash"]
sudo apt-get install qt4-designer
[/sourcecode]

<em>Ohh how I wish windows had a package management system :( </em>

Fire up Qt Desinger and select "Dialog with Buttons Bottom".

Lets throw on a couple of Labels and a few Line Edits for the data. Now set the form to use a Grid Layout (Right Click on empty space on form-&gt;Layout-&gt;Layout in Grid).

Now the trick in making a custom form for QGIS is naming the object the same as the field. So I my case I have a road layer with the following fields.

- Segment_ID
- Parcel_ID
- Name
- Alias_Name
- Locality
- Parcel_type

For my custom form I only care about Segment_ID and Name, so my form looks like:

[caption id="attachment_810" align="aligncenter" width="630" caption="Custom form in Qt Designer"]<a href="http://woostuff.files.wordpress.com/2011/09/designer.png"><img class="size-full wp-image-810" title="Custom form" src="http://woostuff.files.wordpress.com/2011/09/designer.png" alt="" width="630" height="441" /></a>[/caption]

<em>Note that I have set the read only property of the Segment ID line edit to True so that it can't be edited. I don't want people messing around with the ID.</em>

As I said above the tick is in the naming so right click on each line edit and select Change objectName, naming each line edit using the same name as the field. For me the first control is called Segment_ID and the other is called Name.

[caption id="attachment_811" align="aligncenter" width="311" caption="Make sure the objects are the same name as the field."]<a href="http://woostuff.files.wordpress.com/2011/09/objectnaming.png"><img class="size-full wp-image-811" title="ObjectNaming" src="http://woostuff.files.wordpress.com/2011/09/objectnaming.png" alt="" width="311" height="199" /></a>[/caption]

Save the form into a new folder, I have put mine in C:\Temp\Roads. Jump back into QGIS, load the properties dialog for the layer. Select the General tab and set Edit UI to the new form .ui file.

[caption id="attachment_813" align="aligncenter" width="630" caption="Setting the edit form UI file."]<a href="http://woostuff.files.wordpress.com/2011/09/properties.png"><img class="size-full wp-image-813" title="Properties" src="http://woostuff.files.wordpress.com/2011/09/properties.png" alt="" width="630" height="606" /></a>[/caption]

Save and exit the properties window. Enable the layer for editing (or not) and select an object with the Identify Feature tool.

[caption id="attachment_812" align="aligncenter" width="630" caption="Woot! Custom edit form in QGIS."]<a href="http://woostuff.files.wordpress.com/2011/09/mapwithform.png"><img class="size-full wp-image-812" title="MapWithForm" src="http://woostuff.files.wordpress.com/2011/09/mapwithform.png" alt="" width="630" height="429" /></a>[/caption]

Magic! As I'm in edit mode any changes I make to the Name line edit will be reflected back on the layer (but not the Segment ID as it's read only). If you are in non-edit mode then you are given the custom form with everything disabled and a cancel button.
<h2>With Python validation and custom logic.</h2>
Now creating a custom form like above is pretty cool although having some custom Python validation behind it would be even cooler.

What I want to do is add some validation to the Name field so the user can't enter null road names.

First save your QGIS project (as the Python code runner will look where the project is saved for the Python module). Again I have saved mine in C:\Temp\Roads as Roads.qgs. Now lets make a new python file in your favourite text editor and add the following code.

[sourcecode language="python"]
from PyQt4.QtCore import *
from PyQt4.QtGui import *

nameField = None
myDialog = None

def formOpen(dialog,layerid,featureid):
	global myDialog
	myDialog = dialog
	global nameField
	nameField = dialog.findChild(QLineEdit,&quot;Name&quot;)
	buttonBox = dialog.findChild(QDialogButtonBox,&quot;buttonBox&quot;)

	# Disconnect the signal that QGIS has wired up for the dialog to the button box.
	buttonBox.accepted.disconnect(myDialog.accept)

	# Wire up our own signals.
	buttonBox.accepted.connect(validate)
	buttonBox.rejected.connect(myDialog.reject)

def validate():
  # Make sure that the name field isn't empty.
	if not nameField.text().length() &gt; 0:
		msgBox = QMessageBox()
		msgBox.setText(&quot;Name field can not be null.&quot;)
		msgBox.exec_()
	else:
		# Return the form as accpeted to QGIS.
		myDialog.accept()
[/sourcecode]

Wow! What the hell is all that! I'll step though the code to explain each bit.
<h3>Code break down.</h3>
First import the modules from Qt and set up a few global variables to hold the dialog and name field.

[sourcecode language="python"]
from PyQt4.QtCore import *
from PyQt4.QtGui import *

nameField = None
myDialog = None
[/sourcecode]

Now we create a method that QGIS will call when it loads the form. This method takes an instance of our custom dialog, the Layer ID, and the Feature ID.

[sourcecode language="python"]
def formOpen(dialog,layerid,featureid):
[/sourcecode]

Then using the findChild method we want to grab the reference to the Name field and the button box. We are also calling buttonBox.accepted.disconnect() to disconnect the slots that QGIS has auto wired up to our button box, we do this so we can hook up our own accepted logic.

After we have disconnected the accepted signal we can wire up our own call to the validate method using buttonBox.accepted.connect(validate).

[sourcecode language="python"]
global myDialog
myDialog = dialog
global nameField
nameField = dialog.findChild(QLineEdit,&quot;Name&quot;)
buttonBox = dialog.findChild(QDialogButtonBox,&quot;buttonBox&quot;)

# Disconnect the signal that QGIS has wired up for the dialog to the button box.
buttonBox.accepted.disconnect(myDialog.accept)
# Wire up our own signals.
buttonBox.accepted.connect(validate)
buttonBox.rejected.connect(myDialog.reject)
[/sourcecode]

We need a method to validate the logic. This will be called when the signal buttonBox.accepted() is called. The logic in this method should be pretty streight forward. If the Name line edit has a length &gt; 0 then we accept the dialog, if not then we give the user a message and let them fix the mistake.

[sourcecode language="python"]
def validate():
  # Make sure that the name field isn't empty.
	if not nameField.text().length() &gt; 0:
		msgBox = QMessageBox()
		msgBox.setText(&quot;Name field can not be null.&quot;)
		msgBox.exec_()
	else:
		# Return the form as accpeted to QGIS.
		myDialog.accept()
[/sourcecode]
<h2>Almost done!</h2>
Now that you have a Python file with the custom validation logic we need to tell QGIS to use this logic for the form. First save the Python file in the same directory as your project. I have called mine C:\Temp\Roads\RoadForm.py.

Back on the General tab in the layer properties we can set the Init function field. We set this to call the module and function we just made. The syntax is {module name}.{function name}. In my case my module (the Python file we made before) is called RoadForm and the function is called formOpen, so it will be RoadForm.formOpen.

[caption id="attachment_814" align="aligncenter" width="630" caption="Set the Init function field to moduleName.functionName"]<a href="http://woostuff.files.wordpress.com/2011/09/propertiesupdated.png"><img class="size-full wp-image-814" title="PropertiesUpdated" src="http://woostuff.files.wordpress.com/2011/09/propertiesupdated.png" alt="" width="630" height="606" /></a>[/caption]

Save and use the Identify Feature tool to select a feature. You shouldn't get any errors if everything worked ok. Now delete everything in the Name field and hit Ok.

[caption id="attachment_815" align="aligncenter" width="630" caption="Validation in action"]<a href="http://woostuff.files.wordpress.com/2011/09/validate.png"><img class="size-full wp-image-815" title="validate" src="http://woostuff.files.wordpress.com/2011/09/validate.png" alt="" width="630" height="425" /></a>[/caption]

Sweet! The form can now not be accepted if the name field is null.

And that's that. Pretty simple but powerful feature once you know how to set it up.

Enjoy!

<em>If you do end up using this custom form with python logic stuff in the real world, leave a comment and maybe a picture. It would be good to see use cases for this cool QGIS feature.</em>

<strong>Bonus</strong>

Why not add a red highlight to the textbox if something is not valid.

[sourcecode language="python"]
from PyQt4.QtCore import *
from PyQt4.QtGui import *

nameField = None
myDialog = None

def formOpen(dialog,layerid,featureid):
  global myDialog
  myDialog = dialog
  global nameField
  nameField = dialog.findChild(QLineEdit,&quot;Name&quot;)
  buttonBox = dialog.findChild(QDialogButtonBox,&quot;buttonBox&quot;)

  nameField.textChanged.connect(Name_onTextChanged)
  # Disconnect the signal that QGIS has wired up for the dialog to the button box.
  buttonBox.accepted.disconnect(myDialog.accept)
  # Wire up our own signals.
  buttonBox.accepted.connect(validate)
  buttonBox.rejected.connect(myDialog.reject)

def validate():
  # Make sure that the name field isn't empty.
  if not nameField.text().length() &gt; 0:
    nameField.setStyleSheet(&quot;background-color: rgba(255, 107, 107, 150);&quot;)
    msgBox = QMessageBox()
    msgBox.setText(&quot;Name field can not be null.&quot;)
    msgBox.exec_()
  else:
  # Return the form as accpeted to QGIS.
    myDialog.accept()

def Name_onTextChanged(text):
  if not nameField.text().length() &gt; 0:
    nameField.setStyleSheet(&quot;background-color: rgba(255, 107, 107, 150);&quot;)
  else:
    nameField.setStyleSheet(&quot;&quot;)
[/sourcecode]

The key part of of this is nameField.textChanged.connect(Name_onTextChanged) and the Name_onTextChanged(text) method. Give it a try, I think it looks quite nice.

[caption id="attachment_820" align="aligncenter" width="314" caption="Change text background to red on invalid input."]<a href="http://woostuff.files.wordpress.com/2011/09/form.png"><img class="size-full wp-image-820" title="CustomForm" src="http://woostuff.files.wordpress.com/2011/09/form.png" alt="" width="314" height="179" /></a>[/caption]
